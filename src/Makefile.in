# @configure_input@

# Package-specific substitution variables
package = @PACKAGE_NAME@
version = @PACKAGE_VERSION@
tarname = @PACKAGE_TARNAME@
distdir = $(tarname)-$(version)

# Prefix-specific substitution variables
prefix      = @prefix@
includedir  = @includedir@
docdir      = @docdir@
htmldir     = @htmldir@
libdir      = @libdir@
# Supplementary
exec_prefix = @exec_prefix@
libexecdir  = @libexecdir@
lispdir     = @lispdir@
# VPATH-specific substitution variables
srcdir = @srcdir@
VPATH  = @srcdir@

COMPILER=GNU
#COMPILER=INTEL
#COMPILER=LLVM

ifeq ($(COMPILER),GNU)
CC=gcc -g
CFLAGS=-fPIC -fexceptions -Wall -Werror -Wpedantic -Wextra

FC=gfortran -g
FFLAGS=-fPIC -fcheck=all -Waliasing -Wampersand -Wconversion -Wsurprising -Wintrinsics-std -Wno-tabs -Wintrinsic-shadow -Wline-truncation -Wreal-q-constant -Wuninitialized  -fbacktrace -ffpe-trap=zero,overflow,underflow -finit-real=nan

LIBS= -L/usr/lib/x86_64-linux-gnu/hdf5/serial/ -lz -lm -lhdf5 -lhdf5_hl
INCLUDE     = -I/usr/include/hdf5/serial
endif

ifeq ($(COMPILER),INTEL)
CC=icc -xHost
CFLAGS=-fPIC -g -O2 -fexceptions -Wall -Werror -Wextra

FC=ifort -xHost
FFLAGS=-fPIC -g -O2

LIBS= -L/usr/lib/x86_64-linux-gnu/hdf5/serial/ -lz -lhdf5 -lhdf5_hl
INCLUDE     = -I/usr/include/hdf5/serial
endif

#TODO
ifeq ($(COMPILER),LLVM)
CC=clang
CFLAGS=-fPIC -g -O2

FC=flang
FFLAGS=fPIC -g -O2

LIBS=-lm
endif

OBJECT_FILES= trexio.o trexio_text.o trexio_hdf5.o
SOURCE_FILES= test.c trexio.c trexio_hdf5.c trexio_text.c
HEADER_FILES= trexio.h trexio_text.h trexio_hdf5.h trexio_s.h
ORG_FILES= templates_front/templator_front.org  templates_text/templator_text.org \
           templates_hdf5/templator_hdf5.org

TREXIO_LIB= $(prefix)/lib
TREXIO_INCLUDE= $(prefix)/include/trexio


export CC CFLAGS FC FFLAGS LIBS

.PHONY: all clean install
.POSIX:
.SUFFIXES:


all: libtrexio.so fortran


libtrexio.so: $(OBJECT_FILES) $(HEADER_FILES) 
	$(CC) -shared $(OBJECT_FILES) -o libtrexio.so


fortran: trexio_f.o


trexio_f.o: libtrexio.so trexio_f.f90
	$(FC) $(FFLAGS) -c trexio_f.f90 -o trexio_f.o


cppcheck: cppcheck.out
	cat cppcheck.out


cppcheck.out: $(HEADER_FILES) $(SOURCE_FILES)
	cppcheck --addon=cert -q --error-exitcode=0  \
          --enable=warning,performance,portability,missingInclude,information \
          --language=c --std=c99 -rp --platform=unix64  \
          $(INCLUDE) $(SOURCE_FILES) 2>$@


trexio.c trexio_f.f90 trexio.h: $(ORG_FILES)
	./build_trexio.sh


test_c: libtrexio.so test.c
	$(CC) $(CFLAGS) $(INCLUDE) -Wl,-rpath,$(PWD) -L. test.c -ltrexio $(LIBS) -o test_c


test_f: libtrexio.so trexio_f.f90 test.f90
	$(FC) $(FFLAGS) $(INCLUDE) -Wl,-rpath,$(PWD) -L. test.f90 trexio_f.o -ltrexio $(LIBS) -o test_f


check: test_c test_f
	$(RM) -r trexio_test
	$(RM) -r trexio_test_fort
	./test_c
	./test_f

# $(DESTDIR) is needed for future support of package managers
# install should avoid build target due to possible conflict when prefix overriden
install:
	install -d $(DESTDIR)$(TREXIO_LIB) $(DESTDIR)$(TREXIO_INCLUDE)
	cp libtrexio.so $(DESTDIR)$(TREXIO_LIB)
	cp trexio*.h $(DESTDIR)$(TREXIO_INCLUDE)


clean:
	$(RM) *.o libtrexio.so test_*.h5 test_f test_c
	$(RM) -r trexio_test/ trexio_test_fort/


%.o: %.c $(HEADER_FILES)
	$(CC) $(CFLAGS) $(INCLUDE) -c $*.c -o $*.o


Makefile: Makefile.in ../config.status
	cd .. && ./config.status src/$@


../config.status: ../configure
	cd .. && ./config.status --recheck

